---
format: live-html
engine: knitr
lightbox: true
webr:
  resources:
    - https://raw.githubusercontent.com/LizzieWadsworth/Level-4-R-course-book/refs/heads/main/Datasets/LocustSerotonin.csv
  packages:
    - ggplot2
    - dplyr
---

{{< include /_extensions/r-wasm/live/_knitr.qmd >}}

# Chi-squared with multiple categories

Finally, let's look at an example with multiple categories in one of the variables.

Perhaps there is a difference between the reasons students chose the school and which school they attend.

```{webr}
#| context: interactive
#| autorun: true
# Create a contigency table for school verses reason 
school_by_reason <- table(maths_students$school, maths_students$reason)
school_by_reason
```

We can then run the chi-squared test exactly the same as before:

```{webr}
#| context: interactive
#| autorun: true
# Calculate the chi squared test 
chisq <- chisq.test(school_by_reason)

# Print a table of observations
chisq$observed

# Print a table of expected values
chisq$expected

# Print the p-value
chisq$p.value
```

The p-value is 0.00595 (is this less than 0.05?)

We can visualise which factors had the biggest contribution to the result by doing the following calculation:

$100 \times \frac{residuals^2}{statistic}$

We can then visualise this with corrplot.

*There is an issue with web r so this plot isn't interactive*

```{r}
#| echo: false
#| output: false
maths_students=read.csv("student-mat.csv", header=TRUE)
school_by_reason <- table(maths_students$school, maths_students$reason)
chisq <- chisq.test(school_by_reason)
```

```{r}
library(corrplot)

# Run calculation of contributions
contrib <- 100*chisq$residuals^2/chisq$statistic

# Visualise with corrplot
corrplot(contrib, is.cor = FALSE)
```
